# 游戏恢复功能使用指南

## 概述

游戏恢复功能允许服务器在重启后自动恢复中断的游戏，从中断的确切阶段继续，而不是重新开始整个轮次。

## 功能特性

### 🎯 精确阶段恢复
- **法庭辩论阶段**: 继续当前轮次的对话
- **初投票阶段**: 重新开始初投票流程
- **最终申辞阶段**: 恢复申辞环节（自动获取候选人）
- **最终投票阶段**: 重新开始最终投票
- **追加辩论阶段**: 恢复平票后的追加辩论
- **追加投票阶段**: 重新开始追加投票

### 📊 状态跟踪
- 新增 `current_phase` 字段精确跟踪游戏进度
- 自动保存每个阶段的转换状态
- 服务器重启时智能识别中断点

## 安装与部署

### 1. 数据库迁移（仅首次使用）

如果您已有运行中的游戏数据，需要执行一次数据库迁移：

```bash
cd backend
python migrate_database.py
```

或使用快捷脚本：
```bash
cd backend
python run_migration.py
```

### 2. 自动迁移

新安装的系统会在首次启动时自动执行迁移：

```bash
cd backend
python main.py
```

## 工作原理

### 状态追踪

系统现在追踪以下详细阶段：

| 阶段 | 描述 | 恢复策略 |
|------|------|----------|
| `preparing` | 轮次准备中 | 重新开始当前轮次 |
| `chatting` | 法庭辩论进行中 | 继续对话阶段 |
| `initial_voting` | 初投票进行中 | 重新开始初投票 |
| `final_defense` | 最终申辞进行中 | 重新获取候选人并继续申辞 |
| `final_voting` | 最终投票进行中 | 重新开始最终投票 |
| `additional_debate` | 追加辩论进行中 | 重新获取平票候选人并继续 |
| `additional_voting` | 追加投票进行中 | 重新开始追加投票 |
| `finished` | 轮次结束 | 开始下一轮次 |

### 恢复流程

1. **服务器启动时**
   - 自动扫描状态为 "running" 的游戏
   - 检查每个游戏的最新轮次状态
   - 根据 `current_phase` 确定恢复策略

2. **智能恢复**
   - 投票阶段：从数据库重新构建候选人列表
   - 对话阶段：从中断点继续
   - 已完成轮次：自动开始下一轮

3. **容错处理**
   - 无法获取候选人时回退到安全状态
   - 未知状态时重新开始当前轮次
   - 参与者不足时自动结束游戏

## 日志监控

启动时查看以下日志确认恢复状态：

```
🔄 检查是否有需要恢复的游戏...
🎮 发现 1 个中断的游戏，开始恢复...
游戏 1 第1轮 状态: voting, 阶段: final_defense
游戏 1 从第1轮最终申辞阶段恢复
✅ 游戏 1 恢复成功
```

## 常见问题

### Q: 恢复后游戏重新开始了怎么办？
A: 检查数据库是否正确迁移，确保 `current_phase` 字段存在且有正确的值。

### Q: 候选人信息丢失怎么办？
A: 系统会自动从投票记录重建候选人列表，如果失败会回退到安全的投票阶段。

### Q: 如何手动重置游戏状态？
A: 可以直接修改数据库中的 `current_phase` 字段，或将游戏状态设为 "finished"。

## 技术细节

### 数据库结构变更

```sql
-- 新增字段
ALTER TABLE rounds ADD COLUMN current_phase VARCHAR(30) DEFAULT 'preparing';
```

### 状态更新时机

- 每个游戏阶段开始时立即更新状态
- WebSocket消息发送前确保状态已保存
- 异常情况下回滚到前一个稳定状态

## 版本兼容性

- ✅ 新游戏：完全支持所有恢复功能
- ✅ 现有游戏：通过迁移脚本自动升级
- ✅ 向后兼容：不影响现有的游戏逻辑

---

**注意**: 首次部署此功能时，建议在测试环境中验证恢复流程的正确性。 