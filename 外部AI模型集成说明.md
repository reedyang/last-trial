# 外部AI模型集成说明

## 功能概述

此功能允许您将外部OpenWebUI API的AI模型集成到游戏中，与本地Ollama模型一起使用。

## 支持的API格式

- **OpenWebUI兼容API**: 支持标准的OpenAI ChatGPT API格式
- **流式输出**: 支持实时流式文本生成
- **认证**: 支持API密钥认证（可选）

## 使用步骤

### 1. 访问模型管理页面

1. 启动应用后，在首页点击"管理外部模型"按钮
2. 或直接访问 `http://localhost:3000/external-models`

### 2. 添加外部模型

点击"添加模型"按钮，填写以下信息：

- **显示名称**: 在游戏中显示的自定义名称（如：Claude-3.5-Sonnet）
- **API地址**: OpenWebUI实例的完整地址（如：https://your-openwebui-instance.com）
- **模型ID**: 实际的模型标识符（如：anthropic/claude-3-5-sonnet-20241022）
- **API密钥**: 如果API需要认证，填入密钥（可选）
- **描述**: 模型的描述信息（可选）
- **启用状态**: 是否在游戏中可用

### 3. 测试连接

- 在添加/编辑对话框中点击"测试连接"
- 或在模型列表中点击测试图标
- 系统会发送测试消息验证连接和配置

### 4. 在游戏中使用

1. 外部模型会在可用模型列表中显示为 `external:模型名称`
2. 创建游戏时会自动包含启用的外部模型
3. 外部模型与本地模型具有相同的游戏功能

## API兼容性要求

### 必需的端点

```
POST /api/chat/completions
```

### 请求格式

```json
{
  "model": "model-id",
  "messages": [
    {"role": "user", "content": "消息内容"}
  ],
  "stream": false,
  "max_tokens": 500
}
```

### 响应格式

```json
{
  "choices": [
    {
      "message": {
        "content": "AI的回复内容"
      }
    }
  ]
}
```

### 流式响应格式

```
data: {"choices":[{"delta":{"content":"文本片段"}}]}
data: [DONE]
```

## 常见问题

### Q: 测试连接失败怎么办？

A: 检查以下几点：
1. API地址是否正确（包含协议如https://）
2. 模型ID是否存在于目标API中
3. API密钥是否正确（如果需要）
4. 网络连接是否正常
5. 目标API是否兼容OpenAI格式

### Q: 外部模型在游戏中不可用？

A: 确认：
1. 模型状态为"启用"
2. 最近的测试状态为"正常"
3. 重启后端服务以刷新模型列表

### Q: 如何配置不同的API提供商？

A: 不同提供商的配置示例：

**OpenWebUI本地实例**:
- API地址: `http://localhost:8080`
- 模型ID: `llama3.1:8b`

**OpenAI兼容服务**:
- API地址: `https://api.your-service.com`
- 模型ID: `gpt-3.5-turbo`
- API密钥: `sk-...`

**Ollama通过OpenWebUI代理**:
- API地址: `http://your-openwebui:8080`
- 模型ID: `llama2:7b`

## 技术细节

### 数据库表结构

外部模型信息存储在 `external_models` 表中，包含：
- 基本信息（名称、描述）
- API配置（地址、模型ID、密钥）
- 状态管理（启用状态、测试结果）
- 时间戳（创建、更新、最后测试时间）

### 模型识别

外部模型在系统中使用 `external:` 前缀标识，例如：
- 本地模型: `llama3.1:8b`
- 外部模型: `external:Claude-3.5-Sonnet`

### 错误处理

系统包含完整的错误处理机制：
- 连接超时（30秒）
- HTTP状态错误
- 响应格式验证
- 优雅降级（使用备用回复）

## 安全考虑

1. **API密钥安全**: 密钥在数据库中以明文存储，建议使用专用密钥
2. **网络安全**: 建议使用HTTPS连接外部API
3. **访问控制**: 确保外部API的访问权限配置正确
4. **数据隐私**: 了解外部API的数据处理政策

## 维护建议

1. **定期测试**: 定期测试外部模型连接状态
2. **监控日志**: 关注后端日志中的外部模型调用情况
3. **备份配置**: 定期备份外部模型配置
4. **更新管理**: 及时更新API地址和密钥 